-- Script: Draggable NPC Lock Frame with Camera Lock Functionality

local player = game.Players.LocalPlayer
local runService = game:GetService("RunService")
local camera = workspace.CurrentCamera

-- Tạo ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NPCLockGui"
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Tạo Frame bo góc tròn & có thể kéo
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 270, 0, 70)
frame.Position = UDim2.new(0.5, -135, 0.15, 0)
frame.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
frame.BorderSizePixel = 0
frame.Parent = screenGui

-- Bo tròn góc Frame
local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(0, 20)
uicorner.Parent = frame

-- Tạo Label cho tên NPC Lock
local nameLabel = Instance.new("TextLabel")
nameLabel.Text = "Tên NPC Lock"
nameLabel.Size = UDim2.new(0, 120, 1, 0)
nameLabel.Position = UDim2.new(0, 12, 0, 0)
nameLabel.BackgroundTransparency = 1
nameLabel.Font = Enum.Font.SourceSansBold
nameLabel.TextSize = 20
nameLabel.TextXAlignment = Enum.TextXAlignment.Left
nameLabel.TextColor3 = Color3.fromRGB(30,30,30)
nameLabel.Parent = frame

-- Tạo Button On/Off
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 80, 0, 40)
toggleButton.Position = UDim2.new(0, 150, 0.5, -20)
toggleButton.BackgroundColor3 = Color3.fromRGB(55, 180, 75)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 22
toggleButton.Text = "On"
toggleButton.TextColor3 = Color3.fromRGB(255,255,255)
toggleButton.Parent = frame

-- Bo tròn góc Button
local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0, 12)
btnCorner.Parent = toggleButton

-- Drag function cho khung
local dragging = false
local dragInput, mousePos, framePos

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        mousePos = input.Position
        framePos = frame.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - mousePos
        frame.Position = UDim2.new(
            framePos.X.Scale, framePos.X.Offset + delta.X,
            framePos.Y.Scale, framePos.Y.Offset + delta.Y
        )
    end
end)

-- Hàm lấy NPC gần nhất (không phải player, máu > 0)
local function getNearestNPC()
    local nearest
    local minDist = math.huge
    local char = player.Character
    if not char or not char.PrimaryPart then return nil end
    for _, model in ipairs(workspace:GetChildren()) do
        if model:IsA("Model") and model:FindFirstChildOfClass("Humanoid") then
            -- Không lấy player
            if not game.Players:GetPlayerFromCharacter(model) then
                local humanoid = model:FindFirstChildOfClass("Humanoid")
                if humanoid.Health > 0 and model.PrimaryPart then
                    local dist = (char.PrimaryPart.Position - model.PrimaryPart.Position).Magnitude
                    if dist < minDist then
                        minDist = dist
                        nearest = model
                    end
                end
            end
        end
    end
    return nearest
end

-- Logic ON/OFF Camera
local watching = false
local watchingConnection

local function startWatching()
    watching = true
    watchingConnection = runService.RenderStepped:Connect(function()
        if not watching then return end
        local npc = getNearestNPC()
        if npc then
            camera.CameraType = Enum.CameraType.Scriptable
            camera.CFrame = npc.PrimaryPart.CFrame
            nameLabel.Text = npc.Name
        else
            nameLabel.Text = "Không tìm thấy NPC"
        end
    end)
end

local function stopWatching()
    watching = false
    if watchingConnection then
        watchingConnection:Disconnect()
        watchingConnection = nil
    end
    -- Trả lại camera cho người chơi
    camera.CameraType = Enum.CameraType.Custom
    nameLabel.Text = "Tên NPC Lock"
end

-- Sự kiện nút bật/tắt
toggleButton.MouseButton1Click:Connect(function()
    if toggleButton.Text == "On" then
        toggleButton.Text = "Off"
        toggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        startWatching()
    else
        toggleButton.Text = "On"
        toggleButton.BackgroundColor3 = Color3.fromRGB(55, 180, 75)
        stopWatching()
    end
end)

-- Đảm bảo dọn dẹp khi player rời đi
player.AncestryChanged:Connect(function()
    stopWatching()
end)
